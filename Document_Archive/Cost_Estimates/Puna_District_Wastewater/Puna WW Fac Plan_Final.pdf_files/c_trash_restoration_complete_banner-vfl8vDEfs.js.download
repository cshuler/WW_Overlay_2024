!function(){try{var e="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},n=(new e.Error).stack;n&&(e._sentryDebugIds=e._sentryDebugIds||{},e._sentryDebugIds[n]="e1c863fd-e606-3d8c-8b00-41afd8b31649")}catch(e){}}();
define(["exports","react","./c_trash_constants","./e_file_viewer_static_scl_page_file","./e_core_exception","./c_api_v2_routes_restorations_provider","./c_core_i18n","./c_dig-icons_assets_ui-icon_line_syncing","./c_dig-icons_assets_ui-icon_line_upload-folder","./c_spectrum_util_raf_throttle","./e_data_modules_stormcrow","./e_edison","./c_bem","./c_api_v2_routes_plan_configuration_provider","./c_init_data_edison","./c_dotlottie_common_chunk-B7OIQIGJ","./c_src_sink_index","./c_lodash-es_lodash","./c_react-use_misc_util","./c_api_v2_unauthed_client","./c_hive_schemas_sharing-request_access_user_events","./c_core_notify","react-dom","./c_api_v2_routes_team_insights_provider","./c_security_csrf_hmac","./c_react-use_useEffectOnce","./c_pap-events_navigation_select_create_folder_action","react/jsx-runtime","metaserver/static/js/langpack"],(function(e,t,s,a,n,r,o,i,l,c,u,d,m,_,f,p,g,v,h,y,R,w,C,M,b,k,S,I,q){"use strict";function E(e){return e&&e.__esModule?e:{default:e}}var P=E(t);async function N(e,t){return s.GetDeletedFilesRoutes(new a.ActiveUserApiV2Client).rpc("list_restores",{cursor:e,filter:t},{})}const B=o.defineMessages({restorationCompletedWithDetails:{id:"v4dqMS",defaultMessage:"{representativeName} has been restored to {commonParentPath}."},restorationCompletedOverquota:{id:"hTjvJt",defaultMessage:"{representativeName} has been restored to {commonParentPath}, but can't sync until you free up space."},restorationCompletedLocked:{id:"WqypfM",defaultMessage:"{representativeName} has been restored to {commonParentPath}, but can't sync. Your team no longer has full use of {trademark_business} features."},multipleRestorationCompletedWithDetails:{id:"QbDlK1",defaultMessage:"{successes} items have been restored to {commonParentPath}."},multipleRestorationCompletedOverquota:{id:"EADKb/",defaultMessage:"{successes} items have been restored to {commonParentPath}, but can't sync until you free up space."},multipleRestorationCompletedLocked:{id:"WaO4k9",defaultMessage:"{successes} items have been restored to {commonParentPath}, but can't sync. Your team no longer has full use of {trademark_business} features."},restorationFailed:{id:"2G+NZ9",defaultMessage:"{representativeName} failed to restore."},multipleRestorationFailed:{id:"gV1EVw",defaultMessage:"{failures} items failed to restore."},multiplePartialRestorationFailed:{id:"EDjiZ+",defaultMessage:"Some files in {commonParentPath} failed to fully restore."},view:{id:"C9zFRV",defaultMessage:"View"},retry:{id:"8PfGvR",defaultMessage:"Retry"},close:{id:"oMUzwI",defaultMessage:"Close"},dropbox:{id:"TQEyhF",defaultMessage:"Dropbox"}}),O={getOverquotaNameUnknownItems:()=>o.intl.formatMessage({id:"QECGZu",defaultMessage:"Items over storage limit"},{}),getOverquotaNameSingleItem:()=>o.intl.formatMessage({id:"KxxOl6",defaultMessage:"1 item over storage limit"},{}),getOverquotaNameMultipleItems:e=>o.intl.formatMessage({id:"58ugqJ",defaultMessage:"{count} items over storage limit"},{count:e})};o.intl.formatMessage({id:"SociMV",defaultMessage:"Loading"});a.CheckmarkCircleLine,a.FailLine,a.FailLine,i.SyncingLine,i.SyncingLine,l.HelpLine,l.HelpLine;async function V(e){try{const{restores:t,quotaStatus:n}=await async function(e){const t=[];let a,n=!0,r="not_overquota";for(;n;){const s=await N(a,{status_codes:[{".tag":"done"},{".tag":"failed"}],last_modified_since:e.getTime()});t.push(...s.restores||[]),a=s.cursor,n=!0===s.has_more,s.quota_status&&"overquota"===s.quota_status[".tag"]?r="overquota":s.quota_status&&"locked_state"===s.quota_status[".tag"]&&(r="locked_state")}return{restores:s.deduplicateRestorations(t),quotaStatus:r}}(e),r=t.filter((t=>new Date(t.last_modified_time||0)>=e)),o=function(e){var t;const s=[],a=[];for(const n of e)if(n.namespace_id&&n.actioned_items){const e="done"===n.status_code[".tag"]?s:a,r={restorationItems:[],taskId:n.task_id,numToRestore:n.num_to_restore||0};e.push(r);for(const e of n.actioned_items)(e.changeset_id||e.name_override)&&r.restorationItems.push({csId:null!==(t=e.changeset_id)&&void 0!==t?t:0,nsId:n.namespace_id,nameOverride:e.name_override})}return{successes:s,failures:a}}(r),i=function(e){const t=e.flatMap((e=>e.actioned_items||[])),s=t.map((e=>e.mount_path)).filter((e=>void 0!==e)),a=t.filter((e=>e.is_deleted||!e.is_mounted));if(0===s.length||a.length>0)return"/";const n=s[0].split("/");n.pop();let r=n.join("/");""===r&&(r="/");const o=s.reduce(((e,t)=>function(e,t){const s=e.split("/"),a=t.split("/");return s.filter(((e,t)=>e===a[t])).join("/")}(e,t)),r);return o.startsWith("/")?o:"/"+o}(r),l=function(e){for(const r of e)if(r.actioned_items&&r.actioned_items.length>0)for(const e of r.actioned_items){const o=e.is_dir||!1;if(e.mount_path)return{name:a.filename(e.mount_path),isDir:o,canView:Boolean(e.is_mounted&&!e.is_deleted)};if(e.name_override)return{name:`"${t=e.name_override,n=r.num_to_restore||0,t===s.NameOverrides.overquota?0===n?O.getOverquotaNameUnknownItems():1===n?O.getOverquotaNameSingleItem():O.getOverquotaNameMultipleItems(n):t}"`,isDir:o,canView:!1}}var t,n;return{name:"",isDir:!0,canView:!1}}(r);return{...o,commonParentPath:i,representative:l,quotaStatus:n}}catch(t){throw n.reportException({err:t,tags:["trash","get_restorations"],severity:n.SEVERITY.NONCRITICAL,exc_extra:{cutoff_date:e.toISOString()}}),t}}o.intl.formatMessage({id:"zMPkXb",defaultMessage:"Restored"}),o.intl.formatMessage({id:"eCDJ4+",defaultMessage:"Failed"}),o.intl.formatMessage({id:"AQMk0l",defaultMessage:"Canceled"});a.injectInternalStyle("/static/metaserver/static/js/trash/restoration_complete_banner.module.out-vflf7fx5s.css",(e=>"._snackbarContainer_9jslh_1{display:flex;inset:auto 20px 20px 20px;justify-content:center;pointer-events:none;position:fixed;z-index:11012}._snackbarContainer_9jslh_1>*{pointer-events:all}"));const F="_snackbarContainer_9jslh_1";function L(e){return{class:"deleted_files",action:"select",object:"restoration_banner",properties:e}}const A=({restorationsInfo:e,onClose:t,open:i})=>{const l=o.useIntl(),c=a.useCompatNavigate();if(P.default.useEffect((()=>{i&&a.Snackbar.close(s.RESTORATION_SNACKBAR_ID)}),[i]),!e)return null;const u=(e=>{var t,s,n,r;const o="overquota"===e.quotaStatus||"locked_state"===e.quotaStatus,i=!!(null===(t=e.failures)||void 0===t?void 0:t.length),l=!!(null===(s=e.successes)||void 0===s?void 0:s.length),c=(null===(n=e.successes)||void 0===n?void 0:n.reduce(((e,t)=>e+(t.numToRestore||0)),0))||0,u=(null===(r=e.failures)||void 0===r?void 0:r.reduce(((e,t)=>e+(t.numToRestore||0)),0))||0,d=c>1||u>1;if(i&&l)return{type:"partial_failure",variant:"multiple",messageKey:B.multiplePartialRestorationFailed,icon:a.FailLine,showViewButton:!1,showRetryButton:!0,getMessageValues:(e,t)=>({commonParentPath:t})};if(i){const e=d?B.multipleRestorationFailed:B.restorationFailed;return{type:"failure",variant:d?"multiple":"single",messageKey:e,icon:a.FailLine,showViewButton:!1,showRetryButton:!0,getMessageValues:e=>{var t;const s=(null===(t=e.failures)||void 0===t?void 0:t.reduce(((e,t)=>e+(t.numToRestore||0)),0))||0;return{...d?{failures:s}:{representativeName:e.representative.name}}}}}{const t=d?o?"overquota"===e.quotaStatus?B.multipleRestorationCompletedOverquota:B.multipleRestorationCompletedLocked:B.multipleRestorationCompletedWithDetails:o?"overquota"===e.quotaStatus?B.restorationCompletedOverquota:B.restorationCompletedLocked:B.restorationCompletedWithDetails;return{type:"success",variant:d?"multiple":"single",messageKey:t,icon:o?a.WarningLine:a.CheckmarkCircleLine,showViewButton:!0,showRetryButton:!1,getMessageValues:(e,t)=>{var s;const n=(null===(s=e.successes)||void 0===s?void 0:s.reduce(((e,t)=>e+(t.numToRestore||0)),0))||0,r=d?{successes:n,commonParentPath:t}:{representativeName:e.representative.name,commonParentPath:t};return"locked_state"===e.quotaStatus?{...r,trademark_business:a.getTrademarkBusiness()}:r}}}})(e),d=async(e,s)=>{const n=await a.fetchViewer();if(!n.active_user)return;let r,o;if(s)r=e.commonParentPath,o=!0;else if(e.representative.canView){r=`/${e.commonParentPath.replace(/^\/+|\/+$/g,"")}/${e.representative.name.replace(/^\/+|\/+$/g,"")}`,o=e.representative.isDir}else r="/",o=!0;const i=((e,t,s)=>{const n=null==e?void 0:e.active_user;return n&&t?s?a.browse_uri_for_fq_path(e,n,t).toString():a.preview_uri_for_fq_path(n,t).toString():""})(n,r,o);t(),c(i)};let m=e.commonParentPath;"/"===e.commonParentPath&&(m=l.formatMessage(B.dropbox));const _=u.getMessageValues(e,m),f=[...e.successes||[],...e.failures||[]].some((e=>e.restorationItems.some((e=>0!==e.csId))));return P.default.createElement("div",{className:F},P.default.createElement(a.Snackbar$1,{open:i,preferComposition:!0},P.default.createElement(a.Snackbar$1.Accessory,null,P.default.createElement(a.UIIcon,{src:u.icon})),P.default.createElement(a.Snackbar$1.Content,null,P.default.createElement(a.Snackbar$1.Message,null,l.formatMessage(u.messageKey,_)),P.default.createElement(a.Snackbar$1.Actions,null,u.showViewButton&&f&&P.default.createElement(a.Button,{variant:"transparent",onClick:()=>{const t=e.successes.length+e.failures.length;a.WebMiscActivityLogger.log("trash-restoration-banner-view-files",{restoration_count:t,variant:u.variant,banner_type:u.type}),a.UDCL.logEvent(L({deletedFilesRestorationAction:"view_files",deletedFilesRestorationCount:t,deletedFilesVariant:u.variant,deletedFilesBannerType:u.type})),d(e,"multiple"===u.variant)}},l.formatMessage(B.view)),u.showRetryButton&&f&&P.default.createElement(a.Button,{variant:"transparent",onClick:async()=>{const s=e.successes.length+e.failures.length;a.WebMiscActivityLogger.log("trash-restoration-banner-retry",{restoration_count:s,banner_type:u.type}),a.UDCL.logEvent(L({deletedFilesRestorationAction:"retry",deletedFilesRestorationCount:s,deletedFilesVariant:u.variant,deletedFilesBannerType:u.type}));const o=(await a.fetchViewer()).active_user;o&&(!async function(e,t){if(0!==t.failures.length)try{const s=new a.DefaultUserApiV2Client(e),n=t.failures.filter((e=>void 0!==e.taskId));if(n.length>0){const t=e.is_team_admin;await Promise.all([n.flatMap((e=>r.GetRestorationsRoutes(s).rpc("retry",{task_id:e.taskId,allow_retry_for_team_members:t},{})))])}const o=t.failures.filter((e=>void 0===e.taskId));o.length>0&&await r.GetRestorationsRoutes(s).rpc("changeset/restore_true_deletions_batch",{ns_cs_ids:o.flatMap((e=>e.restorationItems.filter((e=>0!==e.csId)).map((e=>({cs_id:e.csId,ns_id:e.nsId}))))),initiation_location:{".tag":"restoration_banner"}},{})}catch(s){throw n.reportException({err:s,tags:["trash","retry_failed_restorations"],severity:n.SEVERITY.NONCRITICAL,exc_extra:{user_id:e.id,failure_count:t.failures.length}}),s}}(o,e),t())}},l.formatMessage(B.retry)),P.default.createElement(a.Button,{variant:"transparent",onClick:t},l.formatMessage(B.close))))))};A.displayName="RestorationBanner";const D=({children:e})=>(()=>{try{return window.self!==window.top}catch(e){return!0}})()?null:P.default.createElement(P.default.Fragment,null,e);D.displayName="RestrictOutsideIframe";const x=({children:e})=>{const[r,o]=t.useState(!1),[i,l]=t.useState(void 0),[d,m]=t.useState(void 0),_=t.useRef(new Date),f=t.useRef(null);t.useEffect((()=>{const e=async()=>{try{if(!c.isAnyUserSignedIn())return;_.current=new Date;const t=await async function(){const e=s.GetDeletedFilesRoutes(new a.ActiveUserApiV2Client);return(await e.rpc("get_restore_processes_bolt_token",void 0,{})).token}(),n=new a.SignedChannelState(t.channel_id.app_id,t.channel_id.unique_id,t.revision,t.token),r=async()=>{s.listRestoresRequestPackage.invalidateQueries(u.queryClient);const e=await V(_.current);e&&(e.successes.length>0||e.failures.length>0)&&(o(!1),l(e),m(e))},i=async()=>{f.current&&(f.current.unsubscribe(),f.current=null),e()};f.current=new a.MetaserverBoltClient([n],r,i),f.current.start()}catch(e){const t=JSON.stringify(e);if(n.NOISY_ERROR_SUBSTRINGS.some((e=>t.includes(e))))return}};return e(),()=>{f.current&&(f.current.unsubscribe(),f.current=null)}}),[]),t.useEffect((()=>{const e=()=>o(!0);return document.addEventListener(a.SNACKBAR_SHOWN,e),()=>{document.removeEventListener(a.SNACKBAR_SHOWN,e)}}),[]);if(e)return P.default.cloneElement(e,{restorationsInfo:i});const p=!!i&&!r;return P.default.createElement(A,{restorationsInfo:i||d,onClose:()=>{l(void 0),_.current=new Date},open:p})};x.displayName="BoltConnectedRestorationSnackbarBanner";const T=()=>P.default.createElement(D,null,P.default.createElement(x,null));T.displayName="RestorationCompleteBanner",e.BoltConnectedRestorationSnackbarBanner=x,e.RestorationCompleteBanner=T,e.RestrictOutsideIframe=D}));
//# sourceMappingURL=c_trash_restoration_complete_banner.js-vfl4vuWR8.map

//# debugId=e1c863fd-e606-3d8c-8b00-41afd8b31649