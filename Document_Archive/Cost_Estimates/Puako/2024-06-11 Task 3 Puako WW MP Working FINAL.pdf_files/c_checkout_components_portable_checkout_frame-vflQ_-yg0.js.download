!function(){try{var e="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},n=(new e.Error).stack;n&&(e._sentryDebugIds=e._sentryDebugIds||{},e._sentryDebugIds[n]="4ade8752-c1c1-30fa-ad9b-db28a1bbd042")}catch(e){}}();
define(["exports","react","./e_file_viewer_static_scl_page_file","./e_core_exception","./c_core_i18n","./c_core_notify","./c_components_order_summary_redesign_order_summary_utils","./e_data_modules_stormcrow"],(function(e,t,o,a,r,s,n,l){"use strict";function i(e){return e&&e.__esModule?e:{default:e}}var c=i(t);const u={plus:o.ProductPlanType.PLUS,plus_trial:o.ProductPlanType.PLUS_TRIAL,professional:o.ProductPlanType.PROFESSIONAL,professional_trial:o.ProductPlanType.PROFESSIONAL_TRIAL,hs_dbx_pro_bundle:o.ProductPlanType.HS_DBX_PRO_BUNDLE,standard:o.ProductPlanType.STANDARD,standard_trial:o.ProductPlanType.STANDARD_TRIAL,advanced:o.ProductPlanType.ADVANCED,advanced_trial:o.ProductPlanType.ADVANCED_TRIAL,dbx_business:o.ProductPlanType.DBX_BUSINESS,dbx_business_trial:o.ProductPlanType.DBX_BUSINESS_TRIAL,dbx_one_business_trial:o.ProductPlanType.DBX_BUSINESS_TRIAL,dbx_business_plus:o.ProductPlanType.DBX_BUSINESS_PLUS,dbx_business_plus_trial:o.ProductPlanType.DBX_BUSINESS_PLUS_TRIAL,dbx_one_business_plus_trial:o.ProductPlanType.DBX_BUSINESS_PLUS_TRIAL,basic:o.ProductPlanType.BASIC,legacy_plus:o.ProductPlanType.PLUS},d=()=>{const{isLoading:e,planInfo:r}=o.useUserPlanInfoQuery();return{productPlanType:t.useMemo((()=>{var t;if(!e&&(null===(t=null==r?void 0:r.serialized_sku_content)||void 0===t?void 0:t.sku_type)){const e=r.serialized_sku_content.sku_type.toLowerCase();if(e in u)return u[e];a.reportStack("No mapping found for user's sku_type",{severity:a.SEVERITY.NONCRITICAL,tags:["trials","useUserProductPlanType","in_trial_messaging"]})}}),[e,r]),isLoading:e}},P="TRIAL_CONVERSION_PORTABLE_CHECKOUT_MODAL",p=[o.ProductPlanType.PLUS,o.ProductPlanType.PROFESSIONAL,o.ProductPlanType.PROFESSIONAL_TRIAL,o.ProductPlanType.HS_DBX_PRO_BUNDLE,o.ProductPlanType.STANDARD,o.ProductPlanType.STANDARD_TRIAL,o.ProductPlanType.ADVANCED,o.ProductPlanType.ADVANCED_TRIAL,o.ProductPlanType.DBX_BUSINESS,o.ProductPlanType.DBX_BUSINESS_TRIAL,o.ProductPlanType.DBX_BUSINESS_PLUS,o.ProductPlanType.DBX_BUSINESS_PLUS_TRIAL,o.ProductPlanType.BASIC_PLUS];class S extends c.default.Component{constructor(e){super(e),this.setIframeRef=e=>{this.iframeRef=e},this.state={isLoading:!0},this.iframeRef=null,this.iframeOrigin=window.location.origin,this.buildPortableCheckoutIframeSrc()}notifyErrorMessage(){const{onIframeLoadError:e}=this.props;s.Notify.error(r.intl.formatMessage({id:"6mM1D3",defaultMessage:"There was an error, please try again."})),e()}notifySuccessMessage(){s.Notify.success(r.intl.formatMessage({id:"RHuVOs",defaultMessage:"Upgrade successful!"}))}buildPortableCheckoutIframeSrc(){const e=this.props.product||o.ProductPlanType.PLUS;_.flexibleCheckoutProductPlanTypes.includes(e)||(a.reportStack(`Invalid product for portable checkout iframe: ${e}`,{severity:a.SEVERITY.CRITICAL,tags:["portable_checkout"]}),this.notifyErrorMessage());const t=new URLSearchParams;t.append("iframe",String(!0)),this.props.promoCode&&t.append("code",this.props.promoCode);const r=_.productPlanTypeToUrl.get(e);e===o.ProductPlanType.STANDARD_TRIAL&&t.append("sku","std"),t.append("should_disable_banner",String(!0));const s=r.includes("?")?"&":"?";let n=`${r}${s}${t}`;this.props.isFromTeamFormationModal&&(t.append("is_team_formation_modal",String(!0)),t.append("action_surface","team_creation_from_shared_folder"),this.props.teamCreationEntryPoint&&t.append("team_creation_entry_point",this.props.teamCreationEntryPoint),n=`/checkout?key=try_fss_standard&${t}`),this.props.campaign?this.iframeSrc=o.addParamToUrl(n,this.props.campaign.versionId,this.props.campaign.campaignId,this.props.campaignLocationTkId)||"":this.iframeSrc=n}receiveMessage(e){var t;const{data:o,origin:a,source:r}=e;if(a!==this.iframeOrigin||r!==(null===(t=this.iframeRef)||void 0===t?void 0:t.contentWindow))return;switch(o.message_type){case n.PortableCheckoutInboundMessageType.IFRAME_INITIALIZED:this.iframeInitialized=!0,this.setState({isLoading:!1}),this.handleIframeLoad();break;case n.PortableCheckoutInboundMessageType.SUCCESSFUL_PURCHASE_COMPLETE:this.notifySuccessMessage(),this.props.onPurchaseSuccess()}}send(e){var t,o;const a=this.iframeOrigin;null===(o=null===(t=this.iframeRef)||void 0===t?void 0:t.contentWindow)||void 0===o||o.postMessage(e,a)}pingIframe(){this.iframeInitialized||(this.pingTimeoutLogged||(this.firstPing?(new Date).getTime()-this.firstPing>2e4&&(a.reportException({err:new Error("Portable checkout iFrame timeout"),severity:a.SEVERITY.NONCRITICAL,tags:["iframe_ping_timeout","portable_checkout"]}),this.pingTimeoutLogged=!0,this.notifyErrorMessage()):this.firstPing=(new Date).getTime()),this.send({message_type:n.PortableCheckoutOutboundMessageType.READY}),this.timeoutId=window.setTimeout((()=>{this.pingIframe()}),250))}handleIframeLoad(){o.ProEventsLogger.log(o.ProEventNames.PORTABLE_CHECKOUT_IFRAME_INITIALIZED),this.props.onIframeLoadSuccess&&this.props.onIframeLoadSuccess()}componentDidMount(){window.addEventListener("message",(e=>this.receiveMessage(e)),!1),this.pingIframe()}componentWillUnmount(){window.removeEventListener("message",(e=>this.receiveMessage(e)),!1),this.timeoutId&&clearTimeout(this.timeoutId)}render(){const e=r.intl.formatMessage({id:"SBkBmA",defaultMessage:"Checkout page"}),t=o.cx("portable-iframe-holder",this.props.classNames);return c.default.createElement("div",{id:"iframe-holder",className:t},this.state.isLoading&&c.default.createElement(o.Spinner,{"data-test-id":"portable-checkout-spinner",className:"portable-spinner","aria-valuetext":r.intl.formatMessage(n.orderSummaryMessages.loading),size:"large",monochromatic:!0}),c.default.createElement("iframe",{ref:this.setIframeRef,src:this.iframeSrc,name:"portable-checkout-iframe",frameBorder:"0",referrerPolicy:"strict-origin",title:e}))}}S.productPlanTypeToUrl=new Map([[o.ProductPlanType.PLUS,"/buy/plus"],[o.ProductPlanType.PLUS_TRIAL,"/plus/try"],[o.ProductPlanType.PROFESSIONAL,"/buy/professional"],[o.ProductPlanType.PROFESSIONAL_TRIAL,"/pro/try"],[o.ProductPlanType.HS_DBX_PRO_BUNDLE,"/buy/essentials"],[o.ProductPlanType.STANDARD,"/buy/business/standard"],[o.ProductPlanType.STANDARD_TRIAL,"/try/business"],[o.ProductPlanType.ADVANCED,"/buy/business/advanced"],[o.ProductPlanType.ADVANCED_TRIAL,"/try/business"],[o.ProductPlanType.DBX_BUSINESS,"/buy/business"],[o.ProductPlanType.DBX_BUSINESS_TRIAL,"/try/teams?sku=business"],[o.ProductPlanType.DBX_BUSINESS_PLUS,"/buy/business-plus"],[o.ProductPlanType.DBX_BUSINESS_PLUS_TRIAL,"/try/teams?sku=business-plus"],[o.ProductPlanType.BASIC_PLUS,"/buy/dbx500"]]),S.flexibleCheckoutProductPlanTypes=p,S.displayName="PortableCheckoutFrameComponent";const _=o.requireCssWithComponent(S,["/static/metaserver/static/css/buy/pages/dropbox_buy-vfl2Z1XLp.css"]),m=r.defineMessage({id:"PjwOeo",defaultMessage:"Close"}),T=({isOpen:e,productPlanType:t,onCloseClick:a,onIframeLoadSuccess:s,onIframeLoadError:n,onPurchaseSuccess:l,promoCode:i="",classNames:u="",isFromTeamFormationModal:d=!1,includeUdclLogging:P=!1,papActionSurface:p,teamCreationEntryPoint:S})=>{const T=r.useIntl().formatMessage(m);return c.default.useEffect((()=>{P&&p&&o.logShownPortableCheckoutModal(o.PortableCheckoutModalEventState.START,p)}),[P,p]),c.default.createElement(o.ThemeProvider,{mode:"bright",theme:"vis2023",_dangerouslyEnableMultipleThemes:!0},c.default.createElement(o.ThemeContainer,null,c.default.createElement(o.Modal,{open:e,width:1e3,isCentered:!0,withCloseButton:T,onRequestClose:()=>{P&&p&&o.logSelectPortableCheckoutModal(o.PortableCheckoutModalActionElement.CLOSE,p,S),null==a||a()},shouldCloseOnOverlayClick:!1,shouldFocusAfterRender:!0,"data-testid":"portable-checkout-modal"},c.default.createElement(_,{product:t,onIframeLoadSuccess:()=>{P&&p&&o.logShownPortableCheckoutModal(o.PortableCheckoutModalEventState.SUCCESS,p,S),null==s||s()},onPurchaseSuccess:()=>{P&&p&&o.logSelectPortableCheckoutModal(o.PortableCheckoutModalActionElement.PURCHASE_SUCCESS,p,S),null==l||l()},onIframeLoadError:()=>{P&&p&&o.logShownPortableCheckoutModal(o.PortableCheckoutModalEventState.FAILED,p,S),null==n||n()},promoCode:i,classNames:u,isFromTeamFormationModal:d,teamCreationEntryPoint:S}))))};T.displayName="PortableCheckoutModal";const y=({productPlanType:e,modalId:t,onCloseClick:a,onIframeLoadSuccess:r,onIframeLoadError:s,onPurchaseSuccess:n})=>{const l=()=>{o.unmountModal(void 0,t)};return c.default.createElement(T,{isOpen:!0,productPlanType:e,onCloseClick:()=>{l(),null==a||a()},onIframeLoadSuccess:()=>{null==r||r()},onIframeLoadError:()=>{null==s||s(),l()},onPurchaseSuccess:()=>{null==n||n(),l(),o.reload()}})};y.displayName="PortableCheckoutModalWrapper";var h=Object.freeze({__proto__:null,PORTABLE_CHECKOUT_SUPPORTED_PRODUCT_PLAN_TYPES:p,PortableCheckoutFrame:_,PortableCheckoutModal:T,openPortableCheckoutModalForTrialConversion:({actionSurface:e,onCloseClick:t,onIframeLoadSuccess:a,onIframeLoadError:s,onPurchaseSuccess:n})=>{o.mountModal(c.default.createElement(l.QueryClientProvider,{client:l.queryClient},c.default.createElement(r.Provider,{value:r.intl},c.default.createElement((()=>{const{productPlanType:r}=d(),l=(e=>{const{user:t}=o.useActiveUser(),a=Boolean(null==t?void 0:t.is_team);switch(e){case o.ProductPlanType.PLUS_TRIAL:return o.ProductPlanType.PLUS;case o.ProductPlanType.PROFESSIONAL_TRIAL:return o.ProductPlanType.PROFESSIONAL;case o.ProductPlanType.STANDARD_TRIAL:return o.ProductPlanType.STANDARD;case o.ProductPlanType.ADVANCED_TRIAL:return o.ProductPlanType.ADVANCED;case o.ProductPlanType.DBX_BUSINESS_TRIAL:return o.ProductPlanType.DBX_BUSINESS;case o.ProductPlanType.DBX_BUSINESS_PLUS_TRIAL:return o.ProductPlanType.DBX_BUSINESS_PLUS;default:return a?o.ProductPlanType.STANDARD:o.ProductPlanType.PLUS}})(r);return c.default.createElement(y,{productPlanType:l,modalId:P,onCloseClick:()=>{o.logSelectPortableCheckoutModal(o.PortableCheckoutModalActionElement.CLOSE,e),null==t||t()},onIframeLoadSuccess:()=>{o.logShownPortableCheckoutModal(o.PortableCheckoutModalEventState.SUCCESS,e),null==a||a()},onIframeLoadError:()=>{o.logShownPortableCheckoutModal(o.PortableCheckoutModalEventState.FAILED,e),null==s||s()},onPurchaseSuccess:()=>{o.logSelectPortableCheckoutModal(o.PortableCheckoutModalActionElement.PURCHASE_SUCCESS,e),null==n||n()}})}),null))),void 0,P)}});e.PORTABLE_CHECKOUT_SUPPORTED_PRODUCT_PLAN_TYPES=p,e.PortableCheckoutFrame=_,e.PortableCheckoutModal=T,e.portable_checkout_frame_esnext=h,e.useUserProductPlanType=d}));
//# sourceMappingURL=c_checkout_components_portable_checkout_frame.js-vflT6QaRk.map

//# debugId=4ade8752-c1c1-30fa-ad9b-db28a1bbd042